jQuery(function($){function openSubmitCouponPopup(){Template.popup('#submit-coupon-popup',{},{'className':'no-padding'});$('#colorbox').find(".submit-coupon-popup").each(function(){var $form=$(this).find('form');var validator=Form.validate($form,{ignore:""});var $button=$(this).find('button');$form.on('change keyup','input[name], textarea[name]',function(){var filled=true;$form.find('input[name], textarea[name]').each(function(){if(!$(this).val().length){filled=false;return false;}});$button.toggleClass('orange',filled);});$form.on('keyup','.description-textarea',function(){var fieldset=$(this).closest('fieldset');var maxTitleLength=fieldset.find('.max_chars').text()-0;var currentTitleLength=$(this).val().length;var $currentChars=fieldset.find('.entered_chars');$currentChars.text(currentTitleLength);if(currentTitleLength>maxTitleLength){$currentChars.css('color','#d40d12');}else{$currentChars.removeAttr('style');}});$button.on('click',function(e){if(!validator.checkForm()){return;}
var form=$(this).closest('form');Page.startLoad('coupon-submit','popup');$.ajax({url:ajaxUrl_ht,type:'post',data:form.serialize()+"&action=coupon_submit",dataType:'json',success:function(response){if(response.success===true){Page.closePopups();Template.popup('#submit-coupon-thanks-popup',{'write_review_link':response.write_review_link,'hosting_name':response.hosting_name},{});}else if(response.errors){Form.putErrors(form,response.errors);}},error:function(){},complete:function(){Page.finishLoad('coupon-submit','#colorbox');}});e.preventDefault();});function scrollToLastCoupon(){}
function initHostingAutocomplete(){$("#colorbox").find("form .coupon-hosting-autocomplete").each(function(){var cache={};$(this).autocomplete({source:function(request,response){var term=request.term;if(term in cache){response(cache[term]);return;}
request['action']='companies_search';$.post(ajaxUrl_ht,request,function(data){cache[term]=data;response(data);});},autoFocus:true,minLength:0,select:function(event,ui){if(ui.item){$(this).closest("form").find('[name="hosting_id"]').val(ui.item.post_id).valid();}},create:function(){jQuery(this).data('ui-autocomplete')._renderItem=function(ul,item){ul.addClass('submit-coupon-hosting-autocomplete sidebar companies-search-results-holder');return jQuery("<li>").attr({"class":'ui-menu-item company-search-choice',"tabindex":'-1'}).html(item.label).appendTo(ul);};},});});}
$(this).on('click','.add-another-coupon',function(){initHostingAutocomplete();var popup=$(this).closest('.submit-coupon-popup');var template=popup.find('.one-coupon').first();var count=popup.find('form').find('.one-coupon').length;var instance=template.clone().show();instance.find('[name*="0"]').each(function(){var $this=$(this);$this.attr('name',$this.attr('name').replace("0",count));});instance.find('.date-picker-input').each(function(){$(this).datepicker({onSelect:function(){$(this).closest('.date-picker-button').find('span').text($(this).val());$(this).trigger('keyup');}});});$(this).before(instance);$button.removeClass('orange');if(count>0){var email=$form.find('[name="coupons['+(count-1)+'][email]"]').val();$form.find('[name="coupons['+count+'][email]"]').val(email);}
$form.find(".cancel-last-coupon").toggle(count>0);Form.update($form);scrollToLastCoupon();});$(this).on('click','.cancel-last-coupon',function(){var popup=$(this).closest('.submit-coupon-popup');var coupons=popup.find('form').find('.one-coupon');var count=coupons.length;$(this).toggle(count>2);if(count>1){coupons.eq(count-1).remove();}
Form.update($form);scrollToLastCoupon();});$(this).find('.add-another-coupon').trigger('click');});}
Page.onHashTag("submit-coupon",openSubmitCouponPopup);});